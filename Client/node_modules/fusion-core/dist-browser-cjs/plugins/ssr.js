"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = createSSRPlugin;
exports.SSRDecider = void 0;

var _createPlugin = require("../create-plugin");

var _sanitization = require("../sanitization");

var _tokens = require("../tokens");

var _appSymbol = require("../utils/app-symbol.js");

var _isBot = require("../utils/is-bot.js");

/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */
const SSRDecider = (0, _createPlugin.createPlugin)({
  deps: {
    enableServerStreaming: _tokens.unstable_EnableServerStreamingToken.optional
  },
  provides: deps => {
    return ctx => {
      // If the request has one of these extensions, we assume it's not something that requires server-side rendering of virtual dom
      // TODO(#46): this check should probably look at the asset manifest to ensure asset 404s are handled correctly
      if (ctx.path.match(/\.(js|js\.map|gif|jpg|png|pdf|json|svg)$/)) return false;

      if ((0, _isBot.isBot)(ctx)) {
        return true;
      } // The Accept header is a good proxy for whether SSR should happen
      // Requesting an HTML page via the browser url bar generates a request with `text/html` in its Accept headers
      // XHR/fetch requests do not have `text/html` in the Accept headers


      if (!ctx.headers.accept) return false;
      if (!ctx.headers.accept.includes('text/html')) return false;
      return deps.enableServerStreaming ? 'stream' : true;
    };
  }
});
exports.SSRDecider = SSRDecider;

function createSSRPlugin(endpoints) {
  return function ssrMiddleware({
    element,
    ssrDecider,
    ssrBodyTemplate,
    ssrShellTemplate
  }) {
    return async function ssrMiddleware(ctx, next) {
      if (endpoints.has(ctx.path)) {
        return next();
      }

      if (!ssrDecider(ctx)) return next();
      const template = {
        htmlAttrs: {},
        bodyAttrs: {},
        title: '',
        head: [],
        body: []
      };
      ctx.element = element;
      ctx.rendered = '';
      ctx.template = template;
      ctx.type = 'text/html';

      if (ssrShellTemplate) {
        ctx.shellTemplate = ssrShellTemplate;
      } // If streaming, add effects to prepare boundary once it drops


      if (ssrDecider(ctx) === 'stream') {
        const app = ctx[_appSymbol.appSymbol]; // Reset in case it has been set

        app.prepareBoundary.reset(); // Add boundary effect to run through all postPrepare effects once the
        // prepare boundary drops

        app.prepareBoundary.addEffect(() => {
          for (const effect of ctx.postPrepareEffects) {
            effect();
          }
        }); // Add boundary effect to serialize any universalValues to head once the prepare
        // boundary drops

        app.prepareBoundary.addEffect(() => {
          ctx.template.head.push(getSerializedUniversalValues(ctx));
        });
      }

      await next(); // Allow someone to override the ssr by setting ctx.body
      // This is especially useful for things like ctx.redirect

      if (ctx.body && ctx.respond !== false) {
        return;
      }

      ctx.template.head.push(getSerializedUniversalValues(ctx));

      if (ssrBodyTemplate) {
        ctx.body = ssrBodyTemplate(ctx);
      } else {
        ctx.body = legacySSRBodyTemplate(ctx);
      }
    };
  };
}

function legacySSRBodyTemplate(ctx) {
  const {
    htmlAttrs,
    bodyAttrs,
    title,
    head,
    body
  } = ctx.template;
  const safeAttrs = Object.keys(htmlAttrs).map(attrKey => {
    return ` ${(0, _sanitization.escape)(attrKey)}="${(0, _sanitization.escape)(htmlAttrs[attrKey])}"`;
  }).join('');
  const safeBodyAttrs = Object.keys(bodyAttrs).map(attrKey => {
    return ` ${(0, _sanitization.escape)(attrKey)}="${(0, _sanitization.escape)(bodyAttrs[attrKey])}"`;
  }).join('');
  const safeTitle = (0, _sanitization.escape)(title);
  const safeHead = head.map(_sanitization.consumeSanitizedHTML).join('');
  const safeBody = body.map(_sanitization.consumeSanitizedHTML).join('');
  const preloadHintLinks = getPreloadHintLinks(ctx);
  const coreGlobals = getCoreGlobals(ctx);
  const chunkScripts = getChunkScripts(ctx);
  const bundleSplittingBootstrap = [preloadHintLinks, coreGlobals, chunkScripts].join('');
  return ['<!doctype html>', `<html${safeAttrs}>`, `<head>`, `<meta charset="utf-8" />`, `<title>${safeTitle}</title>`, `${bundleSplittingBootstrap}${safeHead}`, `</head>`, `<body${safeBodyAttrs}>${ctx.rendered}${safeBody}</body>`, '</html>'].join('');
}

function getCoreGlobals(ctx) {
  const {
    webpackPublicPath,
    nonce
  } = ctx;
  return [`<script nonce="${nonce}">`, `window.performance && window.performance.mark && window.performance.mark('firstRenderStart');`, `__ROUTE_PREFIX__ = ${JSON.stringify(ctx.prefix)};`, // consumed by ./client
  `__WEBPACK_PUBLIC_PATH__ = ${JSON.stringify(webpackPublicPath)};`, // consumed by fusion-clientries/client-entry
  `</script>`].join('');
}

function getUrls({
  chunkUrlMap,
  webpackPublicPath
}, chunks) {
  // cross origin is needed to get meaningful errors in window.onerror
  const isCrossOrigin = webpackPublicPath.startsWith('http');
  const crossOriginAttribute = isCrossOrigin ? ' crossorigin="anonymous"' : '';
  return [...new Set(chunks)].map(id => {
    let url = chunkUrlMap.get(id).get('es5');

    if (webpackPublicPath.endsWith('/')) {
      url = webpackPublicPath + url;
    } else {
      url = webpackPublicPath + '/' + url;
    }

    return {
      url,
      crossOriginAttribute
    };
  });
}

function getChunkScripts(ctx) {
  const sync = getUrls(ctx, ctx.syncChunks).map(({
    url,
    crossOriginAttribute
  }) => {
    return `<script nonce="${ctx.nonce}" defer${crossOriginAttribute} src="${url}"></script>`;
  });
  const preloaded = getUrls(ctx, ctx.preloadChunks.filter(item => !ctx.syncChunks.includes(item))).map(({
    url,
    crossOriginAttribute
  }) => {
    return `<script nonce="${ctx.nonce}" defer${crossOriginAttribute} src="${url}"></script>`;
  });
  return [...preloaded, ...sync].join('');
}

function getPreloadHintLinks(ctx) {
  const chunks = [...ctx.preloadChunks, ...ctx.syncChunks];
  const hints = getUrls(ctx, chunks).map(({
    url,
    crossOriginAttribute
  }) => {
    return `<link rel="preload"${crossOriginAttribute} href="${url}" nonce="${ctx.nonce}" as="script" />`;
  });
  return hints.join('');
}

function getSerializedUniversalValues(ctx) {
  const app = ctx[_appSymbol.appSymbol];
  return (0, _sanitization.html)`<script type="application/json" id="__FUSION_UNIVERSAL_VALUES__">
    ${JSON.stringify({ ...app.universalValues,
    ...ctx.universalValues
  })}
  </script>`;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9wbHVnaW5zL3Nzci5qcyJdLCJuYW1lcyI6WyJTU1JEZWNpZGVyIiwiZGVwcyIsImVuYWJsZVNlcnZlclN0cmVhbWluZyIsInVuc3RhYmxlX0VuYWJsZVNlcnZlclN0cmVhbWluZ1Rva2VuIiwib3B0aW9uYWwiLCJwcm92aWRlcyIsImN0eCIsInBhdGgiLCJtYXRjaCIsImhlYWRlcnMiLCJhY2NlcHQiLCJpbmNsdWRlcyIsImNyZWF0ZVNTUlBsdWdpbiIsImVuZHBvaW50cyIsInNzck1pZGRsZXdhcmUiLCJlbGVtZW50Iiwic3NyRGVjaWRlciIsInNzckJvZHlUZW1wbGF0ZSIsInNzclNoZWxsVGVtcGxhdGUiLCJuZXh0IiwiaGFzIiwidGVtcGxhdGUiLCJodG1sQXR0cnMiLCJib2R5QXR0cnMiLCJ0aXRsZSIsImhlYWQiLCJib2R5IiwicmVuZGVyZWQiLCJ0eXBlIiwic2hlbGxUZW1wbGF0ZSIsImFwcCIsImFwcFN5bWJvbCIsInByZXBhcmVCb3VuZGFyeSIsInJlc2V0IiwiYWRkRWZmZWN0IiwiZWZmZWN0IiwicG9zdFByZXBhcmVFZmZlY3RzIiwicHVzaCIsImdldFNlcmlhbGl6ZWRVbml2ZXJzYWxWYWx1ZXMiLCJyZXNwb25kIiwibGVnYWN5U1NSQm9keVRlbXBsYXRlIiwic2FmZUF0dHJzIiwiT2JqZWN0Iiwia2V5cyIsIm1hcCIsImF0dHJLZXkiLCJqb2luIiwic2FmZUJvZHlBdHRycyIsInNhZmVUaXRsZSIsInNhZmVIZWFkIiwiY29uc3VtZVNhbml0aXplZEhUTUwiLCJzYWZlQm9keSIsInByZWxvYWRIaW50TGlua3MiLCJnZXRQcmVsb2FkSGludExpbmtzIiwiY29yZUdsb2JhbHMiLCJnZXRDb3JlR2xvYmFscyIsImNodW5rU2NyaXB0cyIsImdldENodW5rU2NyaXB0cyIsImJ1bmRsZVNwbGl0dGluZ0Jvb3RzdHJhcCIsIndlYnBhY2tQdWJsaWNQYXRoIiwibm9uY2UiLCJKU09OIiwic3RyaW5naWZ5IiwicHJlZml4IiwiZ2V0VXJscyIsImNodW5rVXJsTWFwIiwiY2h1bmtzIiwiaXNDcm9zc09yaWdpbiIsInN0YXJ0c1dpdGgiLCJjcm9zc09yaWdpbkF0dHJpYnV0ZSIsIlNldCIsImlkIiwidXJsIiwiZ2V0IiwiZW5kc1dpdGgiLCJzeW5jIiwic3luY0NodW5rcyIsInByZWxvYWRlZCIsInByZWxvYWRDaHVua3MiLCJmaWx0ZXIiLCJpdGVtIiwiaGludHMiLCJ1bml2ZXJzYWxWYWx1ZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBUUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBWkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFRQSxNQUFNQSxVQUFVLEdBQUcsZ0NBQWE7QUFDOUJDLEVBQUFBLElBQUksRUFBRTtBQUNKQyxJQUFBQSxxQkFBcUIsRUFBRUMsNENBQW9DQztBQUR2RCxHQUR3QjtBQUk5QkMsRUFBQUEsUUFBUSxFQUFHSixJQUFELElBQVU7QUFDbEIsV0FBUUssR0FBRCxJQUFTO0FBQ2Q7QUFDQTtBQUNBLFVBQUlBLEdBQUcsQ0FBQ0MsSUFBSixDQUFTQyxLQUFULENBQWUsMENBQWYsQ0FBSixFQUNFLE9BQU8sS0FBUDs7QUFFRixVQUFJLGtCQUFNRixHQUFOLENBQUosRUFBZ0I7QUFDZCxlQUFPLElBQVA7QUFDRCxPQVJhLENBVWQ7QUFDQTtBQUNBOzs7QUFDQSxVQUFJLENBQUNBLEdBQUcsQ0FBQ0csT0FBSixDQUFZQyxNQUFqQixFQUF5QixPQUFPLEtBQVA7QUFDekIsVUFBSSxDQUFDSixHQUFHLENBQUNHLE9BQUosQ0FBWUMsTUFBWixDQUFtQkMsUUFBbkIsQ0FBNEIsV0FBNUIsQ0FBTCxFQUErQyxPQUFPLEtBQVA7QUFFL0MsYUFBT1YsSUFBSSxDQUFDQyxxQkFBTCxHQUE2QixRQUE3QixHQUF3QyxJQUEvQztBQUNELEtBakJEO0FBa0JEO0FBdkI2QixDQUFiLENBQW5COzs7QUE0QmUsU0FBU1UsZUFBVCxDQUF5QkMsU0FBekIsRUFBb0M7QUFDakQsU0FBTyxTQUFTQyxhQUFULENBQXVCO0FBQzVCQyxJQUFBQSxPQUQ0QjtBQUU1QkMsSUFBQUEsVUFGNEI7QUFHNUJDLElBQUFBLGVBSDRCO0FBSTVCQyxJQUFBQTtBQUo0QixHQUF2QixFQUtKO0FBQ0QsV0FBTyxlQUFlSixhQUFmLENBQTZCUixHQUE3QixFQUFrQ2EsSUFBbEMsRUFBd0M7QUFDN0MsVUFBSU4sU0FBUyxDQUFDTyxHQUFWLENBQWNkLEdBQUcsQ0FBQ0MsSUFBbEIsQ0FBSixFQUE2QjtBQUMzQixlQUFPWSxJQUFJLEVBQVg7QUFDRDs7QUFDRCxVQUFJLENBQUNILFVBQVUsQ0FBQ1YsR0FBRCxDQUFmLEVBQXNCLE9BQU9hLElBQUksRUFBWDtBQUV0QixZQUFNRSxRQUFRLEdBQUc7QUFDZkMsUUFBQUEsU0FBUyxFQUFFLEVBREk7QUFFZkMsUUFBQUEsU0FBUyxFQUFFLEVBRkk7QUFHZkMsUUFBQUEsS0FBSyxFQUFFLEVBSFE7QUFJZkMsUUFBQUEsSUFBSSxFQUFFLEVBSlM7QUFLZkMsUUFBQUEsSUFBSSxFQUFFO0FBTFMsT0FBakI7QUFPQXBCLE1BQUFBLEdBQUcsQ0FBQ1MsT0FBSixHQUFjQSxPQUFkO0FBQ0FULE1BQUFBLEdBQUcsQ0FBQ3FCLFFBQUosR0FBZSxFQUFmO0FBQ0FyQixNQUFBQSxHQUFHLENBQUNlLFFBQUosR0FBZUEsUUFBZjtBQUNBZixNQUFBQSxHQUFHLENBQUNzQixJQUFKLEdBQVcsV0FBWDs7QUFDQSxVQUFJVixnQkFBSixFQUFzQjtBQUNwQlosUUFBQUEsR0FBRyxDQUFDdUIsYUFBSixHQUFvQlgsZ0JBQXBCO0FBQ0QsT0FuQjRDLENBcUI3Qzs7O0FBQ0EsVUFBSUYsVUFBVSxDQUFDVixHQUFELENBQVYsS0FBb0IsUUFBeEIsRUFBa0M7QUFDaEMsY0FBTXdCLEdBQUcsR0FBR3hCLEdBQUcsQ0FBQ3lCLG9CQUFELENBQWYsQ0FEZ0MsQ0FFaEM7O0FBQ0FELFFBQUFBLEdBQUcsQ0FBQ0UsZUFBSixDQUFvQkMsS0FBcEIsR0FIZ0MsQ0FJaEM7QUFDQTs7QUFDQUgsUUFBQUEsR0FBRyxDQUFDRSxlQUFKLENBQW9CRSxTQUFwQixDQUE4QixNQUFNO0FBQ2xDLGVBQUssTUFBTUMsTUFBWCxJQUFxQjdCLEdBQUcsQ0FBQzhCLGtCQUF6QixFQUE2QztBQUMzQ0QsWUFBQUEsTUFBTTtBQUNQO0FBQ0YsU0FKRCxFQU5nQyxDQVdoQztBQUNBOztBQUNBTCxRQUFBQSxHQUFHLENBQUNFLGVBQUosQ0FBb0JFLFNBQXBCLENBQThCLE1BQU07QUFDbEM1QixVQUFBQSxHQUFHLENBQUNlLFFBQUosQ0FBYUksSUFBYixDQUFrQlksSUFBbEIsQ0FBdUJDLDRCQUE0QixDQUFDaEMsR0FBRCxDQUFuRDtBQUNELFNBRkQ7QUFHRDs7QUFFRCxZQUFNYSxJQUFJLEVBQVYsQ0F4QzZDLENBMEM3QztBQUNBOztBQUNBLFVBQUliLEdBQUcsQ0FBQ29CLElBQUosSUFBWXBCLEdBQUcsQ0FBQ2lDLE9BQUosS0FBZ0IsS0FBaEMsRUFBdUM7QUFDckM7QUFDRDs7QUFFRGpDLE1BQUFBLEdBQUcsQ0FBQ2UsUUFBSixDQUFhSSxJQUFiLENBQWtCWSxJQUFsQixDQUF1QkMsNEJBQTRCLENBQUNoQyxHQUFELENBQW5EOztBQUVBLFVBQUlXLGVBQUosRUFBcUI7QUFDbkJYLFFBQUFBLEdBQUcsQ0FBQ29CLElBQUosR0FBV1QsZUFBZSxDQUFDWCxHQUFELENBQTFCO0FBQ0QsT0FGRCxNQUVPO0FBQ0xBLFFBQUFBLEdBQUcsQ0FBQ29CLElBQUosR0FBV2MscUJBQXFCLENBQUNsQyxHQUFELENBQWhDO0FBQ0Q7QUFDRixLQXZERDtBQXdERCxHQTlERDtBQStERDs7QUFFRCxTQUFTa0MscUJBQVQsQ0FBK0JsQyxHQUEvQixFQUFvQztBQUNsQyxRQUFNO0FBQUNnQixJQUFBQSxTQUFEO0FBQVlDLElBQUFBLFNBQVo7QUFBdUJDLElBQUFBLEtBQXZCO0FBQThCQyxJQUFBQSxJQUE5QjtBQUFvQ0MsSUFBQUE7QUFBcEMsTUFBNENwQixHQUFHLENBQUNlLFFBQXREO0FBQ0EsUUFBTW9CLFNBQVMsR0FBR0MsTUFBTSxDQUFDQyxJQUFQLENBQVlyQixTQUFaLEVBQ2ZzQixHQURlLENBQ1ZDLE9BQUQsSUFBYTtBQUNoQixXQUFRLElBQUcsMEJBQU9BLE9BQVAsQ0FBZ0IsS0FBSSwwQkFBT3ZCLFNBQVMsQ0FBQ3VCLE9BQUQsQ0FBaEIsQ0FBMkIsR0FBMUQ7QUFDRCxHQUhlLEVBSWZDLElBSmUsQ0FJVixFQUpVLENBQWxCO0FBTUEsUUFBTUMsYUFBYSxHQUFHTCxNQUFNLENBQUNDLElBQVAsQ0FBWXBCLFNBQVosRUFDbkJxQixHQURtQixDQUNkQyxPQUFELElBQWE7QUFDaEIsV0FBUSxJQUFHLDBCQUFPQSxPQUFQLENBQWdCLEtBQUksMEJBQU90QixTQUFTLENBQUNzQixPQUFELENBQWhCLENBQTJCLEdBQTFEO0FBQ0QsR0FIbUIsRUFJbkJDLElBSm1CLENBSWQsRUFKYyxDQUF0QjtBQU1BLFFBQU1FLFNBQVMsR0FBRywwQkFBT3hCLEtBQVAsQ0FBbEI7QUFDQSxRQUFNeUIsUUFBUSxHQUFHeEIsSUFBSSxDQUFDbUIsR0FBTCxDQUFTTSxrQ0FBVCxFQUErQkosSUFBL0IsQ0FBb0MsRUFBcEMsQ0FBakI7QUFDQSxRQUFNSyxRQUFRLEdBQUd6QixJQUFJLENBQUNrQixHQUFMLENBQVNNLGtDQUFULEVBQStCSixJQUEvQixDQUFvQyxFQUFwQyxDQUFqQjtBQUVBLFFBQU1NLGdCQUFnQixHQUFHQyxtQkFBbUIsQ0FBQy9DLEdBQUQsQ0FBNUM7QUFDQSxRQUFNZ0QsV0FBVyxHQUFHQyxjQUFjLENBQUNqRCxHQUFELENBQWxDO0FBQ0EsUUFBTWtELFlBQVksR0FBR0MsZUFBZSxDQUFDbkQsR0FBRCxDQUFwQztBQUNBLFFBQU1vRCx3QkFBd0IsR0FBRyxDQUMvQk4sZ0JBRCtCLEVBRS9CRSxXQUYrQixFQUcvQkUsWUFIK0IsRUFJL0JWLElBSitCLENBSTFCLEVBSjBCLENBQWpDO0FBTUEsU0FBTyxDQUNMLGlCQURLLEVBRUosUUFBT0wsU0FBVSxHQUZiLEVBR0osUUFISSxFQUlKLDBCQUpJLEVBS0osVUFBU08sU0FBVSxVQUxmLEVBTUosR0FBRVUsd0JBQXlCLEdBQUVULFFBQVMsRUFObEMsRUFPSixTQVBJLEVBUUosUUFBT0YsYUFBYyxJQUFHekMsR0FBRyxDQUFDcUIsUUFBUyxHQUFFd0IsUUFBUyxTQVI1QyxFQVNMLFNBVEssRUFVTEwsSUFWSyxDQVVBLEVBVkEsQ0FBUDtBQVdEOztBQUVELFNBQVNTLGNBQVQsQ0FBd0JqRCxHQUF4QixFQUE2QjtBQUMzQixRQUFNO0FBQUNxRCxJQUFBQSxpQkFBRDtBQUFvQkMsSUFBQUE7QUFBcEIsTUFBNkJ0RCxHQUFuQztBQUVBLFNBQU8sQ0FDSixrQkFBaUJzRCxLQUFNLElBRG5CLEVBRUosK0ZBRkksRUFHSixzQkFBcUJDLElBQUksQ0FBQ0MsU0FBTCxDQUFleEQsR0FBRyxDQUFDeUQsTUFBbkIsQ0FBMkIsR0FINUMsRUFHZ0Q7QUFDcEQsK0JBQTRCRixJQUFJLENBQUNDLFNBQUwsQ0FBZUgsaUJBQWYsQ0FBa0MsR0FKMUQsRUFJOEQ7QUFDbEUsYUFMSSxFQU1MYixJQU5LLENBTUEsRUFOQSxDQUFQO0FBT0Q7O0FBRUQsU0FBU2tCLE9BQVQsQ0FBaUI7QUFBQ0MsRUFBQUEsV0FBRDtBQUFjTixFQUFBQTtBQUFkLENBQWpCLEVBQW1ETyxNQUFuRCxFQUEyRDtBQUN6RDtBQUNBLFFBQU1DLGFBQWEsR0FBR1IsaUJBQWlCLENBQUNTLFVBQWxCLENBQTZCLE1BQTdCLENBQXRCO0FBQ0EsUUFBTUMsb0JBQW9CLEdBQUdGLGFBQWEsR0FBRywwQkFBSCxHQUFnQyxFQUExRTtBQUNBLFNBQU8sQ0FBQyxHQUFHLElBQUlHLEdBQUosQ0FBUUosTUFBUixDQUFKLEVBQXFCdEIsR0FBckIsQ0FBMEIyQixFQUFELElBQVE7QUFDdEMsUUFBSUMsR0FBRyxHQUFHUCxXQUFXLENBQUNRLEdBQVosQ0FBZ0JGLEVBQWhCLEVBQW9CRSxHQUFwQixDQUF3QixLQUF4QixDQUFWOztBQUNBLFFBQUlkLGlCQUFpQixDQUFDZSxRQUFsQixDQUEyQixHQUEzQixDQUFKLEVBQXFDO0FBQ25DRixNQUFBQSxHQUFHLEdBQUdiLGlCQUFpQixHQUFHYSxHQUExQjtBQUNELEtBRkQsTUFFTztBQUNMQSxNQUFBQSxHQUFHLEdBQUdiLGlCQUFpQixHQUFHLEdBQXBCLEdBQTBCYSxHQUFoQztBQUNEOztBQUNELFdBQU87QUFBQ0EsTUFBQUEsR0FBRDtBQUFNSCxNQUFBQTtBQUFOLEtBQVA7QUFDRCxHQVJNLENBQVA7QUFTRDs7QUFFRCxTQUFTWixlQUFULENBQXlCbkQsR0FBekIsRUFBOEI7QUFDNUIsUUFBTXFFLElBQUksR0FBR1gsT0FBTyxDQUFDMUQsR0FBRCxFQUFNQSxHQUFHLENBQUNzRSxVQUFWLENBQVAsQ0FBNkJoQyxHQUE3QixDQUNYLENBQUM7QUFBQzRCLElBQUFBLEdBQUQ7QUFBTUgsSUFBQUE7QUFBTixHQUFELEtBQWlDO0FBQy9CLFdBQVEsa0JBQWlCL0QsR0FBRyxDQUFDc0QsS0FBTSxVQUFTUyxvQkFBcUIsU0FBUUcsR0FBSSxhQUE3RTtBQUNELEdBSFUsQ0FBYjtBQUtBLFFBQU1LLFNBQVMsR0FBR2IsT0FBTyxDQUN2QjFELEdBRHVCLEVBRXZCQSxHQUFHLENBQUN3RSxhQUFKLENBQWtCQyxNQUFsQixDQUEwQkMsSUFBRCxJQUFVLENBQUMxRSxHQUFHLENBQUNzRSxVQUFKLENBQWVqRSxRQUFmLENBQXdCcUUsSUFBeEIsQ0FBcEMsQ0FGdUIsQ0FBUCxDQUdoQnBDLEdBSGdCLENBR1osQ0FBQztBQUFDNEIsSUFBQUEsR0FBRDtBQUFNSCxJQUFBQTtBQUFOLEdBQUQsS0FBaUM7QUFDckMsV0FBUSxrQkFBaUIvRCxHQUFHLENBQUNzRCxLQUFNLFVBQVNTLG9CQUFxQixTQUFRRyxHQUFJLGFBQTdFO0FBQ0QsR0FMaUIsQ0FBbEI7QUFNQSxTQUFPLENBQUMsR0FBR0ssU0FBSixFQUFlLEdBQUdGLElBQWxCLEVBQXdCN0IsSUFBeEIsQ0FBNkIsRUFBN0IsQ0FBUDtBQUNEOztBQUVELFNBQVNPLG1CQUFULENBQTZCL0MsR0FBN0IsRUFBa0M7QUFDaEMsUUFBTTRELE1BQU0sR0FBRyxDQUFDLEdBQUc1RCxHQUFHLENBQUN3RSxhQUFSLEVBQXVCLEdBQUd4RSxHQUFHLENBQUNzRSxVQUE5QixDQUFmO0FBQ0EsUUFBTUssS0FBSyxHQUFHakIsT0FBTyxDQUFDMUQsR0FBRCxFQUFNNEQsTUFBTixDQUFQLENBQXFCdEIsR0FBckIsQ0FBeUIsQ0FBQztBQUFDNEIsSUFBQUEsR0FBRDtBQUFNSCxJQUFBQTtBQUFOLEdBQUQsS0FBaUM7QUFDdEUsV0FBUSxzQkFBcUJBLG9CQUFxQixVQUFTRyxHQUFJLFlBQVdsRSxHQUFHLENBQUNzRCxLQUFNLGtCQUFwRjtBQUNELEdBRmEsQ0FBZDtBQUdBLFNBQU9xQixLQUFLLENBQUNuQyxJQUFOLENBQVcsRUFBWCxDQUFQO0FBQ0Q7O0FBRUQsU0FBU1IsNEJBQVQsQ0FBc0NoQyxHQUF0QyxFQUEyQztBQUN6QyxRQUFNd0IsR0FBRyxHQUFHeEIsR0FBRyxDQUFDeUIsb0JBQUQsQ0FBZjtBQUNBLFNBQU8sdUJBQUs7QUFDZCxNQUFNOEIsSUFBSSxDQUFDQyxTQUFMLENBQWUsRUFBQyxHQUFHaEMsR0FBRyxDQUFDb0QsZUFBUjtBQUF5QixPQUFHNUUsR0FBRyxDQUFDNEU7QUFBaEMsR0FBZixDQUFpRTtBQUN2RSxZQUZFO0FBR0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKiogQ29weXJpZ2h0IChjKSAyMDE4IFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQG5vZmxvd1xuICovXG5cbmltcG9ydCB7Y3JlYXRlUGx1Z2lufSBmcm9tICcuLi9jcmVhdGUtcGx1Z2luJztcbmltcG9ydCB7ZXNjYXBlLCBjb25zdW1lU2FuaXRpemVkSFRNTCwgaHRtbH0gZnJvbSAnLi4vc2FuaXRpemF0aW9uJztcbmltcG9ydCB7dW5zdGFibGVfRW5hYmxlU2VydmVyU3RyZWFtaW5nVG9rZW59IGZyb20gJy4uL3Rva2Vucyc7XG5pbXBvcnQge2FwcFN5bWJvbH0gZnJvbSAnLi4vdXRpbHMvYXBwLXN5bWJvbC5qcyc7XG5pbXBvcnQge2lzQm90fSBmcm9tICcuLi91dGlscy9pcy1ib3QuanMnO1xuXG5jb25zdCBTU1JEZWNpZGVyID0gY3JlYXRlUGx1Z2luKHtcbiAgZGVwczoge1xuICAgIGVuYWJsZVNlcnZlclN0cmVhbWluZzogdW5zdGFibGVfRW5hYmxlU2VydmVyU3RyZWFtaW5nVG9rZW4ub3B0aW9uYWwsXG4gIH0sXG4gIHByb3ZpZGVzOiAoZGVwcykgPT4ge1xuICAgIHJldHVybiAoY3R4KSA9PiB7XG4gICAgICAvLyBJZiB0aGUgcmVxdWVzdCBoYXMgb25lIG9mIHRoZXNlIGV4dGVuc2lvbnMsIHdlIGFzc3VtZSBpdCdzIG5vdCBzb21ldGhpbmcgdGhhdCByZXF1aXJlcyBzZXJ2ZXItc2lkZSByZW5kZXJpbmcgb2YgdmlydHVhbCBkb21cbiAgICAgIC8vIFRPRE8oIzQ2KTogdGhpcyBjaGVjayBzaG91bGQgcHJvYmFibHkgbG9vayBhdCB0aGUgYXNzZXQgbWFuaWZlc3QgdG8gZW5zdXJlIGFzc2V0IDQwNHMgYXJlIGhhbmRsZWQgY29ycmVjdGx5XG4gICAgICBpZiAoY3R4LnBhdGgubWF0Y2goL1xcLihqc3xqc1xcLm1hcHxnaWZ8anBnfHBuZ3xwZGZ8anNvbnxzdmcpJC8pKVxuICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgIGlmIChpc0JvdChjdHgpKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuXG4gICAgICAvLyBUaGUgQWNjZXB0IGhlYWRlciBpcyBhIGdvb2QgcHJveHkgZm9yIHdoZXRoZXIgU1NSIHNob3VsZCBoYXBwZW5cbiAgICAgIC8vIFJlcXVlc3RpbmcgYW4gSFRNTCBwYWdlIHZpYSB0aGUgYnJvd3NlciB1cmwgYmFyIGdlbmVyYXRlcyBhIHJlcXVlc3Qgd2l0aCBgdGV4dC9odG1sYCBpbiBpdHMgQWNjZXB0IGhlYWRlcnNcbiAgICAgIC8vIFhIUi9mZXRjaCByZXF1ZXN0cyBkbyBub3QgaGF2ZSBgdGV4dC9odG1sYCBpbiB0aGUgQWNjZXB0IGhlYWRlcnNcbiAgICAgIGlmICghY3R4LmhlYWRlcnMuYWNjZXB0KSByZXR1cm4gZmFsc2U7XG4gICAgICBpZiAoIWN0eC5oZWFkZXJzLmFjY2VwdC5pbmNsdWRlcygndGV4dC9odG1sJykpIHJldHVybiBmYWxzZTtcblxuICAgICAgcmV0dXJuIGRlcHMuZW5hYmxlU2VydmVyU3RyZWFtaW5nID8gJ3N0cmVhbScgOiB0cnVlO1xuICAgIH07XG4gIH0sXG59KTtcblxuZXhwb3J0IHtTU1JEZWNpZGVyfTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gY3JlYXRlU1NSUGx1Z2luKGVuZHBvaW50cykge1xuICByZXR1cm4gZnVuY3Rpb24gc3NyTWlkZGxld2FyZSh7XG4gICAgZWxlbWVudCxcbiAgICBzc3JEZWNpZGVyLFxuICAgIHNzckJvZHlUZW1wbGF0ZSxcbiAgICBzc3JTaGVsbFRlbXBsYXRlLFxuICB9KSB7XG4gICAgcmV0dXJuIGFzeW5jIGZ1bmN0aW9uIHNzck1pZGRsZXdhcmUoY3R4LCBuZXh0KSB7XG4gICAgICBpZiAoZW5kcG9pbnRzLmhhcyhjdHgucGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgIH1cbiAgICAgIGlmICghc3NyRGVjaWRlcihjdHgpKSByZXR1cm4gbmV4dCgpO1xuXG4gICAgICBjb25zdCB0ZW1wbGF0ZSA9IHtcbiAgICAgICAgaHRtbEF0dHJzOiB7fSxcbiAgICAgICAgYm9keUF0dHJzOiB7fSxcbiAgICAgICAgdGl0bGU6ICcnLFxuICAgICAgICBoZWFkOiBbXSxcbiAgICAgICAgYm9keTogW10sXG4gICAgICB9O1xuICAgICAgY3R4LmVsZW1lbnQgPSBlbGVtZW50O1xuICAgICAgY3R4LnJlbmRlcmVkID0gJyc7XG4gICAgICBjdHgudGVtcGxhdGUgPSB0ZW1wbGF0ZTtcbiAgICAgIGN0eC50eXBlID0gJ3RleHQvaHRtbCc7XG4gICAgICBpZiAoc3NyU2hlbGxUZW1wbGF0ZSkge1xuICAgICAgICBjdHguc2hlbGxUZW1wbGF0ZSA9IHNzclNoZWxsVGVtcGxhdGU7XG4gICAgICB9XG5cbiAgICAgIC8vIElmIHN0cmVhbWluZywgYWRkIGVmZmVjdHMgdG8gcHJlcGFyZSBib3VuZGFyeSBvbmNlIGl0IGRyb3BzXG4gICAgICBpZiAoc3NyRGVjaWRlcihjdHgpID09PSAnc3RyZWFtJykge1xuICAgICAgICBjb25zdCBhcHAgPSBjdHhbYXBwU3ltYm9sXTtcbiAgICAgICAgLy8gUmVzZXQgaW4gY2FzZSBpdCBoYXMgYmVlbiBzZXRcbiAgICAgICAgYXBwLnByZXBhcmVCb3VuZGFyeS5yZXNldCgpO1xuICAgICAgICAvLyBBZGQgYm91bmRhcnkgZWZmZWN0IHRvIHJ1biB0aHJvdWdoIGFsbCBwb3N0UHJlcGFyZSBlZmZlY3RzIG9uY2UgdGhlXG4gICAgICAgIC8vIHByZXBhcmUgYm91bmRhcnkgZHJvcHNcbiAgICAgICAgYXBwLnByZXBhcmVCb3VuZGFyeS5hZGRFZmZlY3QoKCkgPT4ge1xuICAgICAgICAgIGZvciAoY29uc3QgZWZmZWN0IG9mIGN0eC5wb3N0UHJlcGFyZUVmZmVjdHMpIHtcbiAgICAgICAgICAgIGVmZmVjdCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIC8vIEFkZCBib3VuZGFyeSBlZmZlY3QgdG8gc2VyaWFsaXplIGFueSB1bml2ZXJzYWxWYWx1ZXMgdG8gaGVhZCBvbmNlIHRoZSBwcmVwYXJlXG4gICAgICAgIC8vIGJvdW5kYXJ5IGRyb3BzXG4gICAgICAgIGFwcC5wcmVwYXJlQm91bmRhcnkuYWRkRWZmZWN0KCgpID0+IHtcbiAgICAgICAgICBjdHgudGVtcGxhdGUuaGVhZC5wdXNoKGdldFNlcmlhbGl6ZWRVbml2ZXJzYWxWYWx1ZXMoY3R4KSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCBuZXh0KCk7XG5cbiAgICAgIC8vIEFsbG93IHNvbWVvbmUgdG8gb3ZlcnJpZGUgdGhlIHNzciBieSBzZXR0aW5nIGN0eC5ib2R5XG4gICAgICAvLyBUaGlzIGlzIGVzcGVjaWFsbHkgdXNlZnVsIGZvciB0aGluZ3MgbGlrZSBjdHgucmVkaXJlY3RcbiAgICAgIGlmIChjdHguYm9keSAmJiBjdHgucmVzcG9uZCAhPT0gZmFsc2UpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjdHgudGVtcGxhdGUuaGVhZC5wdXNoKGdldFNlcmlhbGl6ZWRVbml2ZXJzYWxWYWx1ZXMoY3R4KSk7XG5cbiAgICAgIGlmIChzc3JCb2R5VGVtcGxhdGUpIHtcbiAgICAgICAgY3R4LmJvZHkgPSBzc3JCb2R5VGVtcGxhdGUoY3R4KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGN0eC5ib2R5ID0gbGVnYWN5U1NSQm9keVRlbXBsYXRlKGN0eCk7XG4gICAgICB9XG4gICAgfTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gbGVnYWN5U1NSQm9keVRlbXBsYXRlKGN0eCkge1xuICBjb25zdCB7aHRtbEF0dHJzLCBib2R5QXR0cnMsIHRpdGxlLCBoZWFkLCBib2R5fSA9IGN0eC50ZW1wbGF0ZTtcbiAgY29uc3Qgc2FmZUF0dHJzID0gT2JqZWN0LmtleXMoaHRtbEF0dHJzKVxuICAgIC5tYXAoKGF0dHJLZXkpID0+IHtcbiAgICAgIHJldHVybiBgICR7ZXNjYXBlKGF0dHJLZXkpfT1cIiR7ZXNjYXBlKGh0bWxBdHRyc1thdHRyS2V5XSl9XCJgO1xuICAgIH0pXG4gICAgLmpvaW4oJycpO1xuXG4gIGNvbnN0IHNhZmVCb2R5QXR0cnMgPSBPYmplY3Qua2V5cyhib2R5QXR0cnMpXG4gICAgLm1hcCgoYXR0cktleSkgPT4ge1xuICAgICAgcmV0dXJuIGAgJHtlc2NhcGUoYXR0cktleSl9PVwiJHtlc2NhcGUoYm9keUF0dHJzW2F0dHJLZXldKX1cImA7XG4gICAgfSlcbiAgICAuam9pbignJyk7XG5cbiAgY29uc3Qgc2FmZVRpdGxlID0gZXNjYXBlKHRpdGxlKTtcbiAgY29uc3Qgc2FmZUhlYWQgPSBoZWFkLm1hcChjb25zdW1lU2FuaXRpemVkSFRNTCkuam9pbignJyk7XG4gIGNvbnN0IHNhZmVCb2R5ID0gYm9keS5tYXAoY29uc3VtZVNhbml0aXplZEhUTUwpLmpvaW4oJycpO1xuXG4gIGNvbnN0IHByZWxvYWRIaW50TGlua3MgPSBnZXRQcmVsb2FkSGludExpbmtzKGN0eCk7XG4gIGNvbnN0IGNvcmVHbG9iYWxzID0gZ2V0Q29yZUdsb2JhbHMoY3R4KTtcbiAgY29uc3QgY2h1bmtTY3JpcHRzID0gZ2V0Q2h1bmtTY3JpcHRzKGN0eCk7XG4gIGNvbnN0IGJ1bmRsZVNwbGl0dGluZ0Jvb3RzdHJhcCA9IFtcbiAgICBwcmVsb2FkSGludExpbmtzLFxuICAgIGNvcmVHbG9iYWxzLFxuICAgIGNodW5rU2NyaXB0cyxcbiAgXS5qb2luKCcnKTtcblxuICByZXR1cm4gW1xuICAgICc8IWRvY3R5cGUgaHRtbD4nLFxuICAgIGA8aHRtbCR7c2FmZUF0dHJzfT5gLFxuICAgIGA8aGVhZD5gLFxuICAgIGA8bWV0YSBjaGFyc2V0PVwidXRmLThcIiAvPmAsXG4gICAgYDx0aXRsZT4ke3NhZmVUaXRsZX08L3RpdGxlPmAsXG4gICAgYCR7YnVuZGxlU3BsaXR0aW5nQm9vdHN0cmFwfSR7c2FmZUhlYWR9YCxcbiAgICBgPC9oZWFkPmAsXG4gICAgYDxib2R5JHtzYWZlQm9keUF0dHJzfT4ke2N0eC5yZW5kZXJlZH0ke3NhZmVCb2R5fTwvYm9keT5gLFxuICAgICc8L2h0bWw+JyxcbiAgXS5qb2luKCcnKTtcbn1cblxuZnVuY3Rpb24gZ2V0Q29yZUdsb2JhbHMoY3R4KSB7XG4gIGNvbnN0IHt3ZWJwYWNrUHVibGljUGF0aCwgbm9uY2V9ID0gY3R4O1xuXG4gIHJldHVybiBbXG4gICAgYDxzY3JpcHQgbm9uY2U9XCIke25vbmNlfVwiPmAsXG4gICAgYHdpbmRvdy5wZXJmb3JtYW5jZSAmJiB3aW5kb3cucGVyZm9ybWFuY2UubWFyayAmJiB3aW5kb3cucGVyZm9ybWFuY2UubWFyaygnZmlyc3RSZW5kZXJTdGFydCcpO2AsXG4gICAgYF9fUk9VVEVfUFJFRklYX18gPSAke0pTT04uc3RyaW5naWZ5KGN0eC5wcmVmaXgpfTtgLCAvLyBjb25zdW1lZCBieSAuL2NsaWVudFxuICAgIGBfX1dFQlBBQ0tfUFVCTElDX1BBVEhfXyA9ICR7SlNPTi5zdHJpbmdpZnkod2VicGFja1B1YmxpY1BhdGgpfTtgLCAvLyBjb25zdW1lZCBieSBmdXNpb24tY2xpZW50cmllcy9jbGllbnQtZW50cnlcbiAgICBgPC9zY3JpcHQ+YCxcbiAgXS5qb2luKCcnKTtcbn1cblxuZnVuY3Rpb24gZ2V0VXJscyh7Y2h1bmtVcmxNYXAsIHdlYnBhY2tQdWJsaWNQYXRofSwgY2h1bmtzKSB7XG4gIC8vIGNyb3NzIG9yaWdpbiBpcyBuZWVkZWQgdG8gZ2V0IG1lYW5pbmdmdWwgZXJyb3JzIGluIHdpbmRvdy5vbmVycm9yXG4gIGNvbnN0IGlzQ3Jvc3NPcmlnaW4gPSB3ZWJwYWNrUHVibGljUGF0aC5zdGFydHNXaXRoKCdodHRwJyk7XG4gIGNvbnN0IGNyb3NzT3JpZ2luQXR0cmlidXRlID0gaXNDcm9zc09yaWdpbiA/ICcgY3Jvc3NvcmlnaW49XCJhbm9ueW1vdXNcIicgOiAnJztcbiAgcmV0dXJuIFsuLi5uZXcgU2V0KGNodW5rcyldLm1hcCgoaWQpID0+IHtcbiAgICBsZXQgdXJsID0gY2h1bmtVcmxNYXAuZ2V0KGlkKS5nZXQoJ2VzNScpO1xuICAgIGlmICh3ZWJwYWNrUHVibGljUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgICB1cmwgPSB3ZWJwYWNrUHVibGljUGF0aCArIHVybDtcbiAgICB9IGVsc2Uge1xuICAgICAgdXJsID0gd2VicGFja1B1YmxpY1BhdGggKyAnLycgKyB1cmw7XG4gICAgfVxuICAgIHJldHVybiB7dXJsLCBjcm9zc09yaWdpbkF0dHJpYnV0ZX07XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBnZXRDaHVua1NjcmlwdHMoY3R4KSB7XG4gIGNvbnN0IHN5bmMgPSBnZXRVcmxzKGN0eCwgY3R4LnN5bmNDaHVua3MpLm1hcChcbiAgICAoe3VybCwgY3Jvc3NPcmlnaW5BdHRyaWJ1dGV9KSA9PiB7XG4gICAgICByZXR1cm4gYDxzY3JpcHQgbm9uY2U9XCIke2N0eC5ub25jZX1cIiBkZWZlciR7Y3Jvc3NPcmlnaW5BdHRyaWJ1dGV9IHNyYz1cIiR7dXJsfVwiPjwvc2NyaXB0PmA7XG4gICAgfVxuICApO1xuICBjb25zdCBwcmVsb2FkZWQgPSBnZXRVcmxzKFxuICAgIGN0eCxcbiAgICBjdHgucHJlbG9hZENodW5rcy5maWx0ZXIoKGl0ZW0pID0+ICFjdHguc3luY0NodW5rcy5pbmNsdWRlcyhpdGVtKSlcbiAgKS5tYXAoKHt1cmwsIGNyb3NzT3JpZ2luQXR0cmlidXRlfSkgPT4ge1xuICAgIHJldHVybiBgPHNjcmlwdCBub25jZT1cIiR7Y3R4Lm5vbmNlfVwiIGRlZmVyJHtjcm9zc09yaWdpbkF0dHJpYnV0ZX0gc3JjPVwiJHt1cmx9XCI+PC9zY3JpcHQ+YDtcbiAgfSk7XG4gIHJldHVybiBbLi4ucHJlbG9hZGVkLCAuLi5zeW5jXS5qb2luKCcnKTtcbn1cblxuZnVuY3Rpb24gZ2V0UHJlbG9hZEhpbnRMaW5rcyhjdHgpIHtcbiAgY29uc3QgY2h1bmtzID0gWy4uLmN0eC5wcmVsb2FkQ2h1bmtzLCAuLi5jdHguc3luY0NodW5rc107XG4gIGNvbnN0IGhpbnRzID0gZ2V0VXJscyhjdHgsIGNodW5rcykubWFwKCh7dXJsLCBjcm9zc09yaWdpbkF0dHJpYnV0ZX0pID0+IHtcbiAgICByZXR1cm4gYDxsaW5rIHJlbD1cInByZWxvYWRcIiR7Y3Jvc3NPcmlnaW5BdHRyaWJ1dGV9IGhyZWY9XCIke3VybH1cIiBub25jZT1cIiR7Y3R4Lm5vbmNlfVwiIGFzPVwic2NyaXB0XCIgLz5gO1xuICB9KTtcbiAgcmV0dXJuIGhpbnRzLmpvaW4oJycpO1xufVxuXG5mdW5jdGlvbiBnZXRTZXJpYWxpemVkVW5pdmVyc2FsVmFsdWVzKGN0eCkge1xuICBjb25zdCBhcHAgPSBjdHhbYXBwU3ltYm9sXTtcbiAgcmV0dXJuIGh0bWxgPHNjcmlwdCB0eXBlPVwiYXBwbGljYXRpb24vanNvblwiIGlkPVwiX19GVVNJT05fVU5JVkVSU0FMX1ZBTFVFU19fXCI+XG4gICAgJHtKU09OLnN0cmluZ2lmeSh7Li4uYXBwLnVuaXZlcnNhbFZhbHVlcywgLi4uY3R4LnVuaXZlcnNhbFZhbHVlc30pfVxuICA8L3NjcmlwdD5gO1xufVxuIl19