/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */
import { createPlugin } from '../create-plugin';
import { escape, consumeSanitizedHTML, html } from '../sanitization';
import { unstable_EnableServerStreamingToken } from '../tokens';
import { appSymbol } from '../utils/app-symbol.js';
import { isBot } from '../utils/is-bot.js';
const SSRDecider = createPlugin({
  deps: {
    enableServerStreaming: unstable_EnableServerStreamingToken.optional
  },
  provides: deps => {
    return ctx => {
      // If the request has one of these extensions, we assume it's not something that requires server-side rendering of virtual dom
      // TODO(#46): this check should probably look at the asset manifest to ensure asset 404s are handled correctly
      if (ctx.path.match(/\.(js|js\.map|gif|jpg|png|pdf|json|svg)$/)) return false;

      if (isBot(ctx)) {
        return true;
      } // The Accept header is a good proxy for whether SSR should happen
      // Requesting an HTML page via the browser url bar generates a request with `text/html` in its Accept headers
      // XHR/fetch requests do not have `text/html` in the Accept headers


      if (!ctx.headers.accept) return false;
      if (!ctx.headers.accept.includes('text/html')) return false;
      return deps.enableServerStreaming ? 'stream' : true;
    };
  }
});
export { SSRDecider };
export default function createSSRPlugin(endpoints) {
  return function ssrMiddleware({
    element,
    ssrDecider,
    ssrBodyTemplate,
    ssrShellTemplate
  }) {
    return async function ssrMiddleware(ctx, next) {
      if (endpoints.has(ctx.path)) {
        return next();
      }

      if (!ssrDecider(ctx)) return next();
      const template = {
        htmlAttrs: {},
        bodyAttrs: {},
        title: '',
        head: [],
        body: []
      };
      ctx.element = element;
      ctx.rendered = '';
      ctx.template = template;
      ctx.type = 'text/html';

      if (ssrShellTemplate) {
        ctx.shellTemplate = ssrShellTemplate;
      } // If streaming, add effects to prepare boundary once it drops


      if (ssrDecider(ctx) === 'stream') {
        const app = ctx[appSymbol]; // Reset in case it has been set

        app.prepareBoundary.reset(); // Add boundary effect to run through all postPrepare effects once the
        // prepare boundary drops

        app.prepareBoundary.addEffect(() => {
          for (const effect of ctx.postPrepareEffects) {
            effect();
          }
        }); // Add boundary effect to serialize any universalValues to head once the prepare
        // boundary drops

        app.prepareBoundary.addEffect(() => {
          ctx.template.head.push(getSerializedUniversalValues(ctx));
        });
      }

      await next(); // Allow someone to override the ssr by setting ctx.body
      // This is especially useful for things like ctx.redirect

      if (ctx.body && ctx.respond !== false) {
        return;
      }

      ctx.template.head.push(getSerializedUniversalValues(ctx));

      if (ssrBodyTemplate) {
        ctx.body = ssrBodyTemplate(ctx);
      } else {
        ctx.body = legacySSRBodyTemplate(ctx);
      }
    };
  };
}

function legacySSRBodyTemplate(ctx) {
  const {
    htmlAttrs,
    bodyAttrs,
    title,
    head,
    body
  } = ctx.template;
  const safeAttrs = Object.keys(htmlAttrs).map(attrKey => {
    return ` ${escape(attrKey)}="${escape(htmlAttrs[attrKey])}"`;
  }).join('');
  const safeBodyAttrs = Object.keys(bodyAttrs).map(attrKey => {
    return ` ${escape(attrKey)}="${escape(bodyAttrs[attrKey])}"`;
  }).join('');
  const safeTitle = escape(title);
  const safeHead = head.map(consumeSanitizedHTML).join('');
  const safeBody = body.map(consumeSanitizedHTML).join('');
  const preloadHintLinks = getPreloadHintLinks(ctx);
  const coreGlobals = getCoreGlobals(ctx);
  const chunkScripts = getChunkScripts(ctx);
  const bundleSplittingBootstrap = [preloadHintLinks, coreGlobals, chunkScripts].join('');
  return ['<!doctype html>', `<html${safeAttrs}>`, `<head>`, `<meta charset="utf-8" />`, `<title>${safeTitle}</title>`, `${bundleSplittingBootstrap}${safeHead}`, `</head>`, `<body${safeBodyAttrs}>${ctx.rendered}${safeBody}</body>`, '</html>'].join('');
}

function getCoreGlobals(ctx) {
  const {
    webpackPublicPath,
    nonce
  } = ctx;
  return [`<script nonce="${nonce}">`, `window.performance && window.performance.mark && window.performance.mark('firstRenderStart');`, `__ROUTE_PREFIX__ = ${JSON.stringify(ctx.prefix)};`, // consumed by ./client
  `__WEBPACK_PUBLIC_PATH__ = ${JSON.stringify(webpackPublicPath)};`, // consumed by fusion-clientries/client-entry
  `</script>`].join('');
}

function getUrls({
  chunkUrlMap,
  webpackPublicPath
}, chunks) {
  // cross origin is needed to get meaningful errors in window.onerror
  const isCrossOrigin = webpackPublicPath.startsWith('http');
  const crossOriginAttribute = isCrossOrigin ? ' crossorigin="anonymous"' : '';
  return [...new Set(chunks)].map(id => {
    let url = chunkUrlMap.get(id).get('es5');

    if (webpackPublicPath.endsWith('/')) {
      url = webpackPublicPath + url;
    } else {
      url = webpackPublicPath + '/' + url;
    }

    return {
      url,
      crossOriginAttribute
    };
  });
}

function getChunkScripts(ctx) {
  const sync = getUrls(ctx, ctx.syncChunks).map(({
    url,
    crossOriginAttribute
  }) => {
    return `<script nonce="${ctx.nonce}" defer${crossOriginAttribute} src="${url}"></script>`;
  });
  const preloaded = getUrls(ctx, ctx.preloadChunks.filter(item => !ctx.syncChunks.includes(item))).map(({
    url,
    crossOriginAttribute
  }) => {
    return `<script nonce="${ctx.nonce}" defer${crossOriginAttribute} src="${url}"></script>`;
  });
  return [...preloaded, ...sync].join('');
}

function getPreloadHintLinks(ctx) {
  const chunks = [...ctx.preloadChunks, ...ctx.syncChunks];
  const hints = getUrls(ctx, chunks).map(({
    url,
    crossOriginAttribute
  }) => {
    return `<link rel="preload"${crossOriginAttribute} href="${url}" nonce="${ctx.nonce}" as="script" />`;
  });
  return hints.join('');
}

function getSerializedUniversalValues(ctx) {
  const app = ctx[appSymbol];
  return html`<script type="application/json" id="__FUSION_UNIVERSAL_VALUES__">
    ${JSON.stringify({ ...app.universalValues,
    ...ctx.universalValues
  })}
  </script>`;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9wbHVnaW5zL3Nzci5qcyJdLCJuYW1lcyI6WyJjcmVhdGVQbHVnaW4iLCJlc2NhcGUiLCJjb25zdW1lU2FuaXRpemVkSFRNTCIsImh0bWwiLCJ1bnN0YWJsZV9FbmFibGVTZXJ2ZXJTdHJlYW1pbmdUb2tlbiIsImFwcFN5bWJvbCIsImlzQm90IiwiU1NSRGVjaWRlciIsImRlcHMiLCJlbmFibGVTZXJ2ZXJTdHJlYW1pbmciLCJvcHRpb25hbCIsInByb3ZpZGVzIiwiY3R4IiwicGF0aCIsIm1hdGNoIiwiaGVhZGVycyIsImFjY2VwdCIsImluY2x1ZGVzIiwiY3JlYXRlU1NSUGx1Z2luIiwiZW5kcG9pbnRzIiwic3NyTWlkZGxld2FyZSIsImVsZW1lbnQiLCJzc3JEZWNpZGVyIiwic3NyQm9keVRlbXBsYXRlIiwic3NyU2hlbGxUZW1wbGF0ZSIsIm5leHQiLCJoYXMiLCJ0ZW1wbGF0ZSIsImh0bWxBdHRycyIsImJvZHlBdHRycyIsInRpdGxlIiwiaGVhZCIsImJvZHkiLCJyZW5kZXJlZCIsInR5cGUiLCJzaGVsbFRlbXBsYXRlIiwiYXBwIiwicHJlcGFyZUJvdW5kYXJ5IiwicmVzZXQiLCJhZGRFZmZlY3QiLCJlZmZlY3QiLCJwb3N0UHJlcGFyZUVmZmVjdHMiLCJwdXNoIiwiZ2V0U2VyaWFsaXplZFVuaXZlcnNhbFZhbHVlcyIsInJlc3BvbmQiLCJsZWdhY3lTU1JCb2R5VGVtcGxhdGUiLCJzYWZlQXR0cnMiLCJPYmplY3QiLCJrZXlzIiwibWFwIiwiYXR0cktleSIsImpvaW4iLCJzYWZlQm9keUF0dHJzIiwic2FmZVRpdGxlIiwic2FmZUhlYWQiLCJzYWZlQm9keSIsInByZWxvYWRIaW50TGlua3MiLCJnZXRQcmVsb2FkSGludExpbmtzIiwiY29yZUdsb2JhbHMiLCJnZXRDb3JlR2xvYmFscyIsImNodW5rU2NyaXB0cyIsImdldENodW5rU2NyaXB0cyIsImJ1bmRsZVNwbGl0dGluZ0Jvb3RzdHJhcCIsIndlYnBhY2tQdWJsaWNQYXRoIiwibm9uY2UiLCJKU09OIiwic3RyaW5naWZ5IiwicHJlZml4IiwiZ2V0VXJscyIsImNodW5rVXJsTWFwIiwiY2h1bmtzIiwiaXNDcm9zc09yaWdpbiIsInN0YXJ0c1dpdGgiLCJjcm9zc09yaWdpbkF0dHJpYnV0ZSIsIlNldCIsImlkIiwidXJsIiwiZ2V0IiwiZW5kc1dpdGgiLCJzeW5jIiwic3luY0NodW5rcyIsInByZWxvYWRlZCIsInByZWxvYWRDaHVua3MiLCJmaWx0ZXIiLCJpdGVtIiwiaGludHMiLCJ1bml2ZXJzYWxWYWx1ZXMiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBRUEsU0FBUUEsWUFBUixRQUEyQixrQkFBM0I7QUFDQSxTQUFRQyxNQUFSLEVBQWdCQyxvQkFBaEIsRUFBc0NDLElBQXRDLFFBQWlELGlCQUFqRDtBQUNBLFNBQVFDLG1DQUFSLFFBQWtELFdBQWxEO0FBQ0EsU0FBUUMsU0FBUixRQUF3Qix3QkFBeEI7QUFDQSxTQUFRQyxLQUFSLFFBQW9CLG9CQUFwQjtBQUVBLE1BQU1DLFVBQVUsR0FBR1AsWUFBWSxDQUFDO0FBQzlCUSxFQUFBQSxJQUFJLEVBQUU7QUFDSkMsSUFBQUEscUJBQXFCLEVBQUVMLG1DQUFtQyxDQUFDTTtBQUR2RCxHQUR3QjtBQUk5QkMsRUFBQUEsUUFBUSxFQUFHSCxJQUFELElBQVU7QUFDbEIsV0FBUUksR0FBRCxJQUFTO0FBQ2Q7QUFDQTtBQUNBLFVBQUlBLEdBQUcsQ0FBQ0MsSUFBSixDQUFTQyxLQUFULENBQWUsMENBQWYsQ0FBSixFQUNFLE9BQU8sS0FBUDs7QUFFRixVQUFJUixLQUFLLENBQUNNLEdBQUQsQ0FBVCxFQUFnQjtBQUNkLGVBQU8sSUFBUDtBQUNELE9BUmEsQ0FVZDtBQUNBO0FBQ0E7OztBQUNBLFVBQUksQ0FBQ0EsR0FBRyxDQUFDRyxPQUFKLENBQVlDLE1BQWpCLEVBQXlCLE9BQU8sS0FBUDtBQUN6QixVQUFJLENBQUNKLEdBQUcsQ0FBQ0csT0FBSixDQUFZQyxNQUFaLENBQW1CQyxRQUFuQixDQUE0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QUFTUyxvQkFBcUIsU0FBUUcsR0FBSSxhQUE3RTtBQUNELEdBTGlCLENBQWxCO0FBTUEsU0FBTyxDQUFDLEdBQUdLLFNBQUosRUFBZSxHQUFHRixJQUFsQixFQUF3QjVCLElBQXhCLENBQTZCLEVBQTdCLENBQVA7QUFDRDs7QUFFRCxTQUFTTSxtQkFBVCxDQUE2QjdDLEdBQTdCLEVBQWtDO0FBQ2hDLFFBQU0wRCxNQUFNLEdBQUcsQ0FBQyxHQUFHMUQsR0FBRyxDQUFDc0UsYUFBUixFQUF1QixHQUFHdEUsR0FBRyxDQUFDb0UsVUFBOUIsQ0FBZjtBQUNBLFFBQU1LLEtBQUssR0FBR2pCLE9BQU8sQ0FBQ3hELEdBQUQsRUFBTTBELE1BQU4sQ0FBUCxDQUFxQnJCLEdBQXJCLENBQXlCLENBQUM7QUFBQzJCLElBQUFBLEdBQUQ7QUFBTUgsSUFBQUE7QUFBTixHQUFELEtBQWlDO0FBQ3RFLFdBQVEsc0JBQXFCQSxvQkFBcUIsVUFBU0csR0FBSSxZQUFXaEUsR0FBRyxDQUFDb0QsS0FBTSxrQkFBcEY7QUFDRCxHQUZhLENBQWQ7QUFHQSxTQUFPcUIsS0FBSyxDQUFDbEMsSUFBTixDQUFXLEVBQVgsQ0FBUDtBQUNEOztBQUVELFNBQVNSLDRCQUFULENBQXNDL0IsR0FBdEMsRUFBMkM7QUFDekMsUUFBTXdCLEdBQUcsR0FBR3hCLEdBQUcsQ0FBQ1AsU0FBRCxDQUFmO0FBQ0EsU0FBT0YsSUFBSztBQUNkLE1BQU04RCxJQUFJLENBQUNDLFNBQUwsQ0FBZSxFQUFDLEdBQUc5QixHQUFHLENBQUNrRCxlQUFSO0FBQXlCLE9BQUcxRSxHQUFHLENBQUMwRTtBQUFoQyxHQUFmLENBQWlFO0FBQ3ZFLFlBRkU7QUFHRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKiBDb3B5cmlnaHQgKGMpIDIwMTggVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAbm9mbG93XG4gKi9cblxuaW1wb3J0IHtjcmVhdGVQbHVnaW59IGZyb20gJy4uL2NyZWF0ZS1wbHVnaW4nO1xuaW1wb3J0IHtlc2NhcGUsIGNvbnN1bWVTYW5pdGl6ZWRIVE1MLCBodG1sfSBmcm9tICcuLi9zYW5pdGl6YXRpb24nO1xuaW1wb3J0IHt1bnN0YWJsZV9FbmFibGVTZXJ2ZXJTdHJlYW1pbmdUb2tlbn0gZnJvbSAnLi4vdG9rZW5zJztcbmltcG9ydCB7YXBwU3ltYm9sfSBmcm9tICcuLi91dGlscy9hcHAtc3ltYm9sLmpzJztcbmltcG9ydCB7aXNCb3R9IGZyb20gJy4uL3V0aWxzL2lzLWJvdC5qcyc7XG5cbmNvbnN0IFNTUkRlY2lkZXIgPSBjcmVhdGVQbHVnaW4oe1xuICBkZXBzOiB7XG4gICAgZW5hYmxlU2VydmVyU3RyZWFtaW5nOiB1bnN0YWJsZV9FbmFibGVTZXJ2ZXJTdHJlYW1pbmdUb2tlbi5vcHRpb25hbCxcbiAgfSxcbiAgcHJvdmlkZXM6IChkZXBzKSA9PiB7XG4gICAgcmV0dXJuIChjdHgpID0+IHtcbiAgICAgIC8vIElmIHRoZSByZXF1ZXN0IGhhcyBvbmUgb2YgdGhlc2UgZXh0ZW5zaW9ucywgd2UgYXNzdW1lIGl0J3Mgbm90IHNvbWV0aGluZyB0aGF0IHJlcXVpcmVzIHNlcnZlci1zaWRlIHJlbmRlcmluZyBvZiB2aXJ0dWFsIGRvbVxuICAgICAgLy8gVE9ETygjNDYpOiB0aGlzIGNoZWNrIHNob3VsZCBwcm9iYWJseSBsb29rIGF0IHRoZSBhc3NldCBtYW5pZmVzdCB0byBlbnN1cmUgYXNzZXQgNDA0cyBhcmUgaGFuZGxlZCBjb3JyZWN0bHlcbiAgICAgIGlmIChjdHgucGF0aC5tYXRjaCgvXFwuKGpzfGpzXFwubWFwfGdpZnxqcGd8cG5nfHBkZnxqc29ufHN2ZykkLykpXG4gICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgaWYgKGlzQm90KGN0eCkpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG5cbiAgICAgIC8vIFRoZSBBY2NlcHQgaGVhZGVyIGlzIGEgZ29vZCBwcm94eSBmb3Igd2hldGhlciBTU1Igc2hvdWxkIGhhcHBlblxuICAgICAgLy8gUmVxdWVzdGluZyBhbiBIVE1MIHBhZ2UgdmlhIHRoZSBicm93c2VyIHVybCBiYXIgZ2VuZXJhdGVzIGEgcmVxdWVzdCB3aXRoIGB0ZXh0L2h0bWxgIGluIGl0cyBBY2NlcHQgaGVhZGVyc1xuICAgICAgLy8gWEhSL2ZldGNoIHJlcXVlc3RzIGRvIG5vdCBoYXZlIGB0ZXh0L2h0bWxgIGluIHRoZSBBY2NlcHQgaGVhZGVyc1xuICAgICAgaWYgKCFjdHguaGVhZGVycy5hY2NlcHQpIHJldHVybiBmYWxzZTtcbiAgICAgIGlmICghY3R4LmhlYWRlcnMuYWNjZXB0LmluY2x1ZGVzKCd0ZXh0L2h0bWwnKSkgcmV0dXJuIGZhbHNlO1xuXG4gICAgICByZXR1cm4gZGVwcy5lbmFibGVTZXJ2ZXJTdHJlYW1pbmcgPyAnc3RyZWFtJyA6IHRydWU7XG4gICAgfTtcbiAgfSxcbn0pO1xuXG5leHBvcnQge1NTUkRlY2lkZXJ9O1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBjcmVhdGVTU1JQbHVnaW4oZW5kcG9pbnRzKSB7XG4gIHJldHVybiBmdW5jdGlvbiBzc3JNaWRkbGV3YXJlKHtcbiAgICBlbGVtZW50LFxuICAgIHNzckRlY2lkZXIsXG4gICAgc3NyQm9keVRlbXBsYXRlLFxuICAgIHNzclNoZWxsVGVtcGxhdGUsXG4gIH0pIHtcbiAgICByZXR1cm4gYXN5bmMgZnVuY3Rpb24gc3NyTWlkZGxld2FyZShjdHgsIG5leHQpIHtcbiAgICAgIGlmIChlbmRwb2ludHMuaGFzKGN0eC5wYXRoKSkge1xuICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgfVxuICAgICAgaWYgKCFzc3JEZWNpZGVyKGN0eCkpIHJldHVybiBuZXh0KCk7XG5cbiAgICAgIGNvbnN0IHRlbXBsYXRlID0ge1xuICAgICAgICBodG1sQXR0cnM6IHt9LFxuICAgICAgICBib2R5QXR0cnM6IHt9LFxuICAgICAgICB0aXRsZTogJycsXG4gICAgICAgIGhlYWQ6IFtdLFxuICAgICAgICBib2R5OiBbXSxcbiAgICAgIH07XG4gICAgICBjdHguZWxlbWVudCA9IGVsZW1lbnQ7XG4gICAgICBjdHgucmVuZGVyZWQgPSAnJztcbiAgICAgIGN0eC50ZW1wbGF0ZSA9IHRlbXBsYXRlO1xuICAgICAgY3R4LnR5cGUgPSAndGV4dC9odG1sJztcbiAgICAgIGlmIChzc3JTaGVsbFRlbXBsYXRlKSB7XG4gICAgICAgIGN0eC5zaGVsbFRlbXBsYXRlID0gc3NyU2hlbGxUZW1wbGF0ZTtcbiAgICAgIH1cblxuICAgICAgLy8gSWYgc3RyZWFtaW5nLCBhZGQgZWZmZWN0cyB0byBwcmVwYXJlIGJvdW5kYXJ5IG9uY2UgaXQgZHJvcHNcbiAgICAgIGlmIChzc3JEZWNpZGVyKGN0eCkgPT09ICdzdHJlYW0nKSB7XG4gICAgICAgIGNvbnN0IGFwcCA9IGN0eFthcHBTeW1ib2xdO1xuICAgICAgICAvLyBSZXNldCBpbiBjYXNlIGl0IGhhcyBiZWVuIHNldFxuICAgICAgICBhcHAucHJlcGFyZUJvdW5kYXJ5LnJlc2V0KCk7XG4gICAgICAgIC8vIEFkZCBib3VuZGFyeSBlZmZlY3QgdG8gcnVuIHRocm91Z2ggYWxsIHBvc3RQcmVwYXJlIGVmZmVjdHMgb25jZSB0aGVcbiAgICAgICAgLy8gcHJlcGFyZSBib3VuZGFyeSBkcm9wc1xuICAgICAgICBhcHAucHJlcGFyZUJvdW5kYXJ5LmFkZEVmZmVjdCgoKSA9PiB7XG4gICAgICAgICAgZm9yIChjb25zdCBlZmZlY3Qgb2YgY3R4LnBvc3RQcmVwYXJlRWZmZWN0cykge1xuICAgICAgICAgICAgZWZmZWN0KCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgLy8gQWRkIGJvdW5kYXJ5IGVmZmVjdCB0byBzZXJpYWxpemUgYW55IHVuaXZlcnNhbFZhbHVlcyB0byBoZWFkIG9uY2UgdGhlIHByZXBhcmVcbiAgICAgICAgLy8gYm91bmRhcnkgZHJvcHNcbiAgICAgICAgYXBwLnByZXBhcmVCb3VuZGFyeS5hZGRFZmZlY3QoKCkgPT4ge1xuICAgICAgICAgIGN0eC50ZW1wbGF0ZS5oZWFkLnB1c2goZ2V0U2VyaWFsaXplZFVuaXZlcnNhbFZhbHVlcyhjdHgpKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IG5leHQoKTtcblxuICAgICAgLy8gQWxsb3cgc29tZW9uZSB0byBvdmVycmlkZSB0aGUgc3NyIGJ5IHNldHRpbmcgY3R4LmJvZHlcbiAgICAgIC8vIFRoaXMgaXMgZXNwZWNpYWxseSB1c2VmdWwgZm9yIHRoaW5ncyBsaWtlIGN0eC5yZWRpcmVjdFxuICAgICAgaWYgKGN0eC5ib2R5ICYmIGN0eC5yZXNwb25kICE9PSBmYWxzZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGN0eC50ZW1wbGF0ZS5oZWFkLnB1c2goZ2V0U2VyaWFsaXplZFVuaXZlcnNhbFZhbHVlcyhjdHgpKTtcblxuICAgICAgaWYgKHNzckJvZHlUZW1wbGF0ZSkge1xuICAgICAgICBjdHguYm9keSA9IHNzckJvZHlUZW1wbGF0ZShjdHgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY3R4LmJvZHkgPSBsZWdhY3lTU1JCb2R5VGVtcGxhdGUoY3R4KTtcbiAgICAgIH1cbiAgICB9O1xuICB9O1xufVxuXG5mdW5jdGlvbiBsZWdhY3lTU1JCb2R5VGVtcGxhdGUoY3R4KSB7XG4gIGNvbnN0IHtodG1sQXR0cnMsIGJvZHlBdHRycywgdGl0bGUsIGhlYWQsIGJvZHl9ID0gY3R4LnRlbXBsYXRlO1xuICBjb25zdCBzYWZlQXR0cnMgPSBPYmplY3Qua2V5cyhodG1sQXR0cnMpXG4gICAgLm1hcCgoYXR0cktleSkgPT4ge1xuICAgICAgcmV0dXJuIGAgJHtlc2NhcGUoYXR0cktleSl9PVwiJHtlc2NhcGUoaHRtbEF0dHJzW2F0dHJLZXldKX1cImA7XG4gICAgfSlcbiAgICAuam9pbignJyk7XG5cbiAgY29uc3Qgc2FmZUJvZHlBdHRycyA9IE9iamVjdC5rZXlzKGJvZHlBdHRycylcbiAgICAubWFwKChhdHRyS2V5KSA9PiB7XG4gICAgICByZXR1cm4gYCAke2VzY2FwZShhdHRyS2V5KX09XCIke2VzY2FwZShib2R5QXR0cnNbYXR0cktleV0pfVwiYDtcbiAgICB9KVxuICAgIC5qb2luKCcnKTtcblxuICBjb25zdCBzYWZlVGl0bGUgPSBlc2NhcGUodGl0bGUpO1xuICBjb25zdCBzYWZlSGVhZCA9IGhlYWQubWFwKGNvbnN1bWVTYW5pdGl6ZWRIVE1MKS5qb2luKCcnKTtcbiAgY29uc3Qgc2FmZUJvZHkgPSBib2R5Lm1hcChjb25zdW1lU2FuaXRpemVkSFRNTCkuam9pbignJyk7XG5cbiAgY29uc3QgcHJlbG9hZEhpbnRMaW5rcyA9IGdldFByZWxvYWRIaW50TGlua3MoY3R4KTtcbiAgY29uc3QgY29yZUdsb2JhbHMgPSBnZXRDb3JlR2xvYmFscyhjdHgpO1xuICBjb25zdCBjaHVua1NjcmlwdHMgPSBnZXRDaHVua1NjcmlwdHMoY3R4KTtcbiAgY29uc3QgYnVuZGxlU3BsaXR0aW5nQm9vdHN0cmFwID0gW1xuICAgIHByZWxvYWRIaW50TGlua3MsXG4gICAgY29yZUdsb2JhbHMsXG4gICAgY2h1bmtTY3JpcHRzLFxuICBdLmpvaW4oJycpO1xuXG4gIHJldHVybiBbXG4gICAgJzwhZG9jdHlwZSBodG1sPicsXG4gICAgYDxodG1sJHtzYWZlQXR0cnN9PmAsXG4gICAgYDxoZWFkPmAsXG4gICAgYDxtZXRhIGNoYXJzZXQ9XCJ1dGYtOFwiIC8+YCxcbiAgICBgPHRpdGxlPiR7c2FmZVRpdGxlfTwvdGl0bGU+YCxcbiAgICBgJHtidW5kbGVTcGxpdHRpbmdCb290c3RyYXB9JHtzYWZlSGVhZH1gLFxuICAgIGA8L2hlYWQ+YCxcbiAgICBgPGJvZHkke3NhZmVCb2R5QXR0cnN9PiR7Y3R4LnJlbmRlcmVkfSR7c2FmZUJvZHl9PC9ib2R5PmAsXG4gICAgJzwvaHRtbD4nLFxuICBdLmpvaW4oJycpO1xufVxuXG5mdW5jdGlvbiBnZXRDb3JlR2xvYmFscyhjdHgpIHtcbiAgY29uc3Qge3dlYnBhY2tQdWJsaWNQYXRoLCBub25jZX0gPSBjdHg7XG5cbiAgcmV0dXJuIFtcbiAgICBgPHNjcmlwdCBub25jZT1cIiR7bm9uY2V9XCI+YCxcbiAgICBgd2luZG93LnBlcmZvcm1hbmNlICYmIHdpbmRvdy5wZXJmb3JtYW5jZS5tYXJrICYmIHdpbmRvdy5wZXJmb3JtYW5jZS5tYXJrKCdmaXJzdFJlbmRlclN0YXJ0Jyk7YCxcbiAgICBgX19ST1VURV9QUkVGSVhfXyA9ICR7SlNPTi5zdHJpbmdpZnkoY3R4LnByZWZpeCl9O2AsIC8vIGNvbnN1bWVkIGJ5IC4vY2xpZW50XG4gICAgYF9fV0VCUEFDS19QVUJMSUNfUEFUSF9fID0gJHtKU09OLnN0cmluZ2lmeSh3ZWJwYWNrUHVibGljUGF0aCl9O2AsIC8vIGNvbnN1bWVkIGJ5IGZ1c2lvbi1jbGllbnRyaWVzL2NsaWVudC1lbnRyeVxuICAgIGA8L3NjcmlwdD5gLFxuICBdLmpvaW4oJycpO1xufVxuXG5mdW5jdGlvbiBnZXRVcmxzKHtjaHVua1VybE1hcCwgd2VicGFja1B1YmxpY1BhdGh9LCBjaHVua3MpIHtcbiAgLy8gY3Jvc3Mgb3JpZ2luIGlzIG5lZWRlZCB0byBnZXQgbWVhbmluZ2Z1bCBlcnJvcnMgaW4gd2luZG93Lm9uZXJyb3JcbiAgY29uc3QgaXNDcm9zc09yaWdpbiA9IHdlYnBhY2tQdWJsaWNQYXRoLnN0YXJ0c1dpdGgoJ2h0dHAnKTtcbiAgY29uc3QgY3Jvc3NPcmlnaW5BdHRyaWJ1dGUgPSBpc0Nyb3NzT3JpZ2luID8gJyBjcm9zc29yaWdpbj1cImFub255bW91c1wiJyA6ICcnO1xuICByZXR1cm4gWy4uLm5ldyBTZXQoY2h1bmtzKV0ubWFwKChpZCkgPT4ge1xuICAgIGxldCB1cmwgPSBjaHVua1VybE1hcC5nZXQoaWQpLmdldCgnZXM1Jyk7XG4gICAgaWYgKHdlYnBhY2tQdWJsaWNQYXRoLmVuZHNXaXRoKCcvJykpIHtcbiAgICAgIHVybCA9IHdlYnBhY2tQdWJsaWNQYXRoICsgdXJsO1xuICAgIH0gZWxzZSB7XG4gICAgICB1cmwgPSB3ZWJwYWNrUHVibGljUGF0aCArICcvJyArIHVybDtcbiAgICB9XG4gICAgcmV0dXJuIHt1cmwsIGNyb3NzT3JpZ2luQXR0cmlidXRlfTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGdldENodW5rU2NyaXB0cyhjdHgpIHtcbiAgY29uc3Qgc3luYyA9IGdldFVybHMoY3R4LCBjdHguc3luY0NodW5rcykubWFwKFxuICAgICh7dXJsLCBjcm9zc09yaWdpbkF0dHJpYnV0ZX0pID0+IHtcbiAgICAgIHJldHVybiBgPHNjcmlwdCBub25jZT1cIiR7Y3R4Lm5vbmNlfVwiIGRlZmVyJHtjcm9zc09yaWdpbkF0dHJpYnV0ZX0gc3JjPVwiJHt1cmx9XCI+PC9zY3JpcHQ+YDtcbiAgICB9XG4gICk7XG4gIGNvbnN0IHByZWxvYWRlZCA9IGdldFVybHMoXG4gICAgY3R4LFxuICAgIGN0eC5wcmVsb2FkQ2h1bmtzLmZpbHRlcigoaXRlbSkgPT4gIWN0eC5zeW5jQ2h1bmtzLmluY2x1ZGVzKGl0ZW0pKVxuICApLm1hcCgoe3VybCwgY3Jvc3NPcmlnaW5BdHRyaWJ1dGV9KSA9PiB7XG4gICAgcmV0dXJuIGA8c2NyaXB0IG5vbmNlPVwiJHtjdHgubm9uY2V9XCIgZGVmZXIke2Nyb3NzT3JpZ2luQXR0cmlidXRlfSBzcmM9XCIke3VybH1cIj48L3NjcmlwdD5gO1xuICB9KTtcbiAgcmV0dXJuIFsuLi5wcmVsb2FkZWQsIC4uLnN5bmNdLmpvaW4oJycpO1xufVxuXG5mdW5jdGlvbiBnZXRQcmVsb2FkSGludExpbmtzKGN0eCkge1xuICBjb25zdCBjaHVua3MgPSBbLi4uY3R4LnByZWxvYWRDaHVua3MsIC4uLmN0eC5zeW5jQ2h1bmtzXTtcbiAgY29uc3QgaGludHMgPSBnZXRVcmxzKGN0eCwgY2h1bmtzKS5tYXAoKHt1cmwsIGNyb3NzT3JpZ2luQXR0cmlidXRlfSkgPT4ge1xuICAgIHJldHVybiBgPGxpbmsgcmVsPVwicHJlbG9hZFwiJHtjcm9zc09yaWdpbkF0dHJpYnV0ZX0gaHJlZj1cIiR7dXJsfVwiIG5vbmNlPVwiJHtjdHgubm9uY2V9XCIgYXM9XCJzY3JpcHRcIiAvPmA7XG4gIH0pO1xuICByZXR1cm4gaGludHMuam9pbignJyk7XG59XG5cbmZ1bmN0aW9uIGdldFNlcmlhbGl6ZWRVbml2ZXJzYWxWYWx1ZXMoY3R4KSB7XG4gIGNvbnN0IGFwcCA9IGN0eFthcHBTeW1ib2xdO1xuICByZXR1cm4gaHRtbGA8c2NyaXB0IHR5cGU9XCJhcHBsaWNhdGlvbi9qc29uXCIgaWQ9XCJfX0ZVU0lPTl9VTklWRVJTQUxfVkFMVUVTX19cIj5cbiAgICAke0pTT04uc3RyaW5naWZ5KHsuLi5hcHAudW5pdmVyc2FsVmFsdWVzLCAuLi5jdHgudW5pdmVyc2FsVmFsdWVzfSl9XG4gIDwvc2NyaXB0PmA7XG59XG4iXX0=